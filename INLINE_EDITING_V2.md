# 内联编辑 v2.0 - 全区域可编辑

## 🎯 核心理念

**除了红色删除区域，所有内容都可以直接编辑**

## ✨ 可编辑区域

### 1. **未变更的文本** ✅
```
普通文本段落
可以直接点击编辑
无需特殊标注
```

### 2. **新增的内容（绿色背景）** ✅
```
━━━━━━━━━━━━━━
🟢 新增
新添加的文本
可以直接编辑
━━━━━━━━━━━━━━
```

### 3. **删除的内容（红色背景）** ❌
```
━━━━━━━━━━━━━━
🔴 删除
被̶删̶除̶的̶文̶本̶
不可编辑
━━━━━━━━━━━━━━
```

## 🎨 视觉反馈

### 未激活状态
```
正常显示，无特殊标记
只有轻微的背景色区分
```

### 鼠标悬停
```
淡淡的背景高亮
提示可以编辑
```

### 聚焦编辑
```
青绿色外框高亮（outline）
表示正在编辑
```

### 删除区域
```
红色背景
删除线样式
鼠标变为"禁止"图标
无法选中文本
```

## 💡 使用方式

### 编辑未变更文本
```
1. 点击任何普通文本
2. 光标出现，开始输入
3. 失焦自动保存
4. 系统重新计算 diff
```

### 编辑新增内容
```
1. 点击绿色背景的新增区域
2. 修改新增的文本
3. 失焦自动保存
4. 更新到"新文本"
5. 重新计算 diff
```

### 无法编辑删除内容
```
尝试点击红色删除区域
→ 鼠标显示禁止图标
→ 无法选中文本
→ 保持只读状态
```

## 🔄 数据同步

### 编辑未变更文本
```
编辑普通文本
    ↓
失焦触发 syncChangesToOriginal()
    ↓
重建原始文本 (originalText)
    ↓
更新 Tiptap 编辑器（侧边栏）
    ↓
重新计算 diff
    ↓
主视图更新
```

### 编辑新增内容
```
编辑绿色新增区域
    ↓
失焦触发 syncChangesToNew()
    ↓
重建新文本 (newText)
    ↓
更新 Tiptap 编辑器（侧边栏）
    ↓
重新计算 diff
    ↓
主视图更新
```

## 🎯 实际应用

### 场景 1：快速修正
```
查看 diff 时发现：
- 未变更部分有错别字 → 直接点击修改
- 新增内容需要微调 → 直接点击修改
- 删除内容确认无误 → 保持不变
```

### 场景 2：边审查边优化
```
审查变更块：
✓ 接受某些变更
✗ 拒绝某些变更
✏️ 同时微调未变更和新增的部分
```

### 场景 3：迭代式编辑
```
第一轮：审查所有 diff
第二轮：在原地直接优化
第三轮：应用更改
持续迭代...
```

## 🎨 样式设计

### 简洁原则
- ❌ 移除"可编辑区域"标签
- ❌ 移除虚线边框
- ❌ 移除头部提示
- ✅ 只在聚焦时显示outline
- ✅ 自然的编辑体验

### 颜色语义
- **红色**：删除（不可编辑）
- **绿色**：新增（可编辑）
- **无色**：未变更（可编辑）
- **青绿色**：聚焦状态

### 交互反馈
```css
/* 可编辑区域 */
:hover → 淡淡的背景高亮
:focus → 青绿色 outline
::selection → 青绿色选中背景

/* 删除区域 */
cursor: not-allowed
user-select: none
text-decoration: line-through
```

## 🔧 技术实现

### 双缓存系统
```javascript
editableSegments    // 缓存未变更文本的编辑
editableNewTexts    // 缓存新增内容的编辑
```

### 智能同步
```javascript
// 未变更文本
onEditableChange()  → 缓存编辑
syncChangesToOriginal() → 同步到 originalText

// 新增文本
onNewTextChange()  → 缓存编辑
syncChangesToNew() → 同步到 newText
```

### 自动重算
```javascript
编辑 → 失焦 → 同步 → calculateDiff() → 界面更新
```

## ⚡ 性能优化

### 延迟同步
- 编辑时只缓存，不计算
- 失焦时批量同步
- 避免频繁重算 diff

### 局部更新
- 只更新变化的文本
- Tiptap 编辑器增量更新
- 最小化性能开销

## 💡 最佳实践

### 推荐工作流
```
1. 查看主视图的 diff 对比
2. 发现需要修改的地方
3. 直接在原地点击编辑
4. 失焦自动保存
5. 继续审查其他变更
```

### 组合使用
```
主视图：
- 直接编辑小修改
- 快速调整细节

侧边栏：
- 大段文本编辑
- 结构化修改
```

### 开关控制
```
工具栏 "✏️ 编辑中" 按钮：
- 开启：所有区域可编辑（除删除外）
- 关闭：全部只读，只能查看
```

## 🎯 与传统方式对比

### 传统方式
```
1. 查看 diff
2. 发现问题
3. 回到编辑器
4. 找到对应位置
5. 修改
6. 重新生成 diff
7. 再次查看
```

### 现在的方式
```
1. 查看 diff
2. 直接在原地编辑 ✨
3. 自动更新
```

## 🔒 安全设计

### 防误操作
- 删除区域不可编辑
- 失焦自动保存（无需手动）
- 可随时撤销（侧边栏）

### 数据一致性
- 编辑同步到文本变量
- Tiptap 编辑器同步更新
- Diff 自动重新计算
- 三者始终保持一致

## 📝 注意事项

### ⚠️ 重要提示

1. **编辑会重新计算 diff**
   - 修改后立即重算
   - 之前的接受/拒绝状态可能重置

2. **删除区域不可编辑**
   - 红色背景的内容是只读的
   - 如需修改，在侧边栏操作

3. **失焦自动保存**
   - 点击其他地方会自动保存
   - 无需手动保存按钮

4. **双向同步**
   - 主视图编辑 → 同步到侧边栏
   - 侧边栏编辑 → 主视图重新计算

### 💡 小技巧

- **Tab 键**：快速切换到下一个可编辑区域
- **Esc 键**：取消编辑（浏览器默认）
- **Ctrl+Z**：在 Tiptap 编辑器中撤销

## 🚀 未来扩展

可能的功能：
- [ ] 批量编辑模式
- [ ] 实时协作编辑
- [ ] 编辑历史记录
- [ ] 智能建议
- [ ] 快捷键支持

---

**总结**：现在的编辑体验更加自然流畅，除了红色删除区域，所有内容都可以无缝编辑，没有多余的视觉干扰！✨


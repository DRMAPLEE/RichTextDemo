# 内联编辑功能说明

## 功能概述

现在未变更的文本部分（equal segments）变成了**可编辑区域**，你可以直接在diff视图中编辑这些文本，实时修改原始文档。

## 使用方法

### 1. 开启/关闭编辑模式

工具栏右侧有一个切换按钮：
```
[✏️ 编辑中]  ← 点击切换
[🔒 只读]
```

- **✏️ 编辑中**：未变更文本可以编辑
- **🔒 只读**：未变更文本只读显示

### 2. 编辑未变更文本

当编辑模式开启时：

```
╔══════════════════════════════════╗
║ ✏️ 可编辑区域  直接编辑即可修改文本 ║
║────────────────────────────────║
║ function calculateTotal(items) { ║  ← 可以直接点击编辑
║   let total = 0;                 ║
║   ...                            ║
╚══════════════════════════════════╝
```

**操作步骤**：
1. 点击任何可编辑区域
2. 直接输入、删除、修改文本
3. 点击外部或按 Tab 键失焦
4. 系统自动同步更改并重新计算差异

## 视觉反馈

### 可编辑区域状态

#### 默认状态
```
边框：虚线灰色
背景：透明
标题栏："✏️ 可编辑区域"
```

#### 鼠标悬停
```
边框：蓝色虚线
背景：淡蓝色
光标：变为文本光标
```

#### 聚焦编辑
```
边框：青绿色实线
背景：淡青绿色
外发光：青绿色光晕
选中文本：青绿色高亮
```

## 工作原理

### 编辑流程
```
1. 用户点击可编辑区域
   ↓
2. contenteditable 启用
   ↓
3. 用户编辑文本（@input 事件）
   ↓
4. 临时存储到 editableSegments Map
   ↓
5. 用户失焦（@blur 事件）
   ↓
6. syncChangesToOriginal() 触发
   ↓
7. 重建原始文本（合并所有段落）
   ↓
8. 更新 originalText
   ↓
9. 重新计算差异（calculateDiff）
   ↓
10. 界面刷新，显示新的 diff
```

### 数据同步

```javascript
// 1. 存储编辑
editableSegments.set(segmentIndex, newText)

// 2. 重建文本
for each segment:
  if (segment is EQUAL):
    if (edited):
      add edited text
    else:
      add original text
  else if (segment is DELETE):
    add to original (保留删除的内容)

// 3. 更新原文
originalText = rebuilt text

// 4. 重新计算 diff
calculateDiff()
```

## 使用场景

### 场景 1：快速修正错别字
```
在查看 diff 时发现原文有错别字
  ↓
直接在可编辑区域修改
  ↓
系统重新计算差异
  ↓
继续审查其他变更
```

### 场景 2：同时编辑和审查
```
审查 AI 建议的改进：
  • 变更块 #1：接受
  • 可编辑区域：手动调整格式
  • 变更块 #2：拒绝
  • 可编辑区域：添加注释
  • 变更块 #3：接受
```

### 场景 3：迭代式优化
```
第一轮：审查所有变更
  ↓
在可编辑区域微调未变更部分
  ↓
应用所有更改
  ↓
第二轮：继续优化
```

### 场景 4：保持上下文编辑
```
查看完整上下文：
┌─────────────────┐
│ 未变更代码 ✏️   │ ← 可以直接修改
├─────────────────┤
│ 🔄 变更块       │ ← 接受/拒绝
├─────────────────┤
│ 未变更代码 ✏️   │ ← 可以直接修改
└─────────────────┘
```

## 技术特点

### 1. 实时同步
- ✅ 编辑立即缓存
- ✅ 失焦时自动同步
- ✅ 自动重新计算 diff
- ✅ 界面平滑更新

### 2. 性能优化
- ✅ 使用 Map 缓存编辑
- ✅ 批量更新（失焦时）
- ✅ 避免频繁重算
- ✅ 只在必要时触发

### 3. 用户体验
- ✅ 即点即编
- ✅ 视觉反馈明确
- ✅ 可随时开关
- ✅ 无需手动保存

### 4. 代码高亮
- ✅ 保持 monospace 字体
- ✅ 保留空格和缩进
- ✅ 支持多行编辑
- ✅ Tab 键支持

## 快捷操作

### 编辑时
- **点击**：进入编辑模式
- **Ctrl/Cmd + A**：全选区域文本
- **Ctrl/Cmd + C/V**：复制粘贴
- **Tab / Shift+Tab**：切换到下一个/上一个区域
- **失焦**：自动保存更改

### 导航
- **鼠标滚轮**：浏览文档
- **点击外部**：退出编辑并保存

## 注意事项

### ⚠️ 重要提示

1. **编辑会重新计算 diff**
   - 修改后会重新对比
   - 之前的接受/拒绝状态会重置（如果内容变化）

2. **只编辑未变更部分**
   - 变更块本身不可编辑
   - 只有 equal segments 可以编辑

3. **自动同步**
   - 失焦时自动保存
   - 无需手动点击保存按钮

4. **可撤销**
   - 编辑前的状态保存在侧边栏的输入框中
   - 可以从侧边栏恢复

### 💡 最佳实践

1. **先审查，后编辑**
   - 先查看所有变更
   - 理解整体差异
   - 然后决定是否需要编辑

2. **小步编辑**
   - 一次编辑一个小部分
   - 及时查看 diff 变化
   - 避免大幅度修改

3. **结合侧边栏**
   - 侧边栏可以编辑整个文档
   - 主视图用于精确定位编辑
   - 两者配合使用最佳

4. **开关编辑模式**
   - 只审查时：关闭编辑（避免误触）
   - 需要修改时：开启编辑
   - 灵活切换

## 与其他功能的集成

### 接受/拒绝变更
```
编辑未变更部分 → 不影响
接受/拒绝决策 → 正常工作
```

### 应用更改
```
编辑 + 接受/拒绝 → 一起应用到最终结果
```

### 侧边栏编辑
```
主视图编辑 → 更新原始文本
侧边栏显示 → 同步更新
反之亦然
```

### 复制结果
```
最终结果 = 编辑后的未变更部分 + 已接受的变更
```

## 对比传统方式

### 传统方式
```
1. 查看 diff
2. 发现需要修改原文
3. 切换到编辑器
4. 找到对应位置
5. 修改
6. 保存
7. 重新对比
```

### 现在的方式
```
1. 查看 diff
2. 直接在原地编辑
3. 自动同步 ✨
```

## 未来扩展可能

- [ ] 支持 Tiptap 富文本编辑
- [ ] 语法高亮集成
- [ ] 智能补全
- [ ] 撤销/重做栈
- [ ] 协作编辑
- [ ] 版本历史

---

**总结**：内联编辑让你在审查差异的同时，无缝修改原文，提供了更加流畅和高效的工作体验！✨

